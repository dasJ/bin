#!/usr/bin/env bash

set -euo pipefail

apiurl="$(git config --get gitlab.url)/api/v4"
slug="$(git config --get gitlab.slug)"
token="$(git config --get gitlab.token)"
branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
declare -A uidCache

# Urlencode a string
urlencode() {
	local string="${1}"
	local strlen=${#string}
	local encoded=""
	local pos c o

	for (( pos=0 ; pos<strlen ; pos++ )); do
		c=${string:$pos:1}
		case "$c" in
			[-_.~a-zA-Z0-9])
				o="${c}"
				;;
			*)
				printf -v o '%%%02x' "'$c"
		esac
		encoded+="${o}"
	done
	echo "${encoded}"
}

# Run curl with auth
curl() {
	command curl -s -H "Authorization: Bearer ${token}" "${@}"
}

# Fetch the UID of a user by name
fetchUid() {
	# Fetch from the cache if cached
	if [[ -v uidCache["$1"] ]]; then
		echo "${uidCache[\"$1\"]}"
		return
	fi
	uid="$(curl "${apiurl}/users/?username=$(urlencode "${1}")" | jq '.[].id')"
	if [ -z "${uid}" ]; then
		echo "User ${1} does not exist" >&2
		exit 1
	fi
	uidCache["${1}"]="${uid}"
	echo "${uid}"
}

# Parse arguments
labels=()
assignees=()
reviewers=()
needsUpdate=0
usage() {
	echo "Usage: git mr [-h] [-t title] [-b body] [-l label].. [-a assignee].. [-r reviewer].."
	exit "${1}"
}
while getopts "ht:b:l:a:r:" o; do
	case "${o}" in
		t)
			title="${OPTARG}"
			needsUpdate=1
			;;
		b)
			body="${OPTARG}"
			needsUpdate=1
			;;
		l)
			labels+=("${OPTARG}")
			needsUpdate=1
			;;
		a)
			assignees+=("${OPTARG}")
			needsUpdate=1
			;;
		r)
			reviewers+=("${OPTARG}")
			needsUpdate=1
			;;
		h)
			usage 0
			;;
		*)
			usage 1
			;;
	esac
done

# Format params
if [ "${#labels[@]}" != 0 ]; then
	labelsParam='&labels='
	first=1
	for label in "${labels[@]}"; do
		if [ "${first}" = 1 ]; then
			first=0
		else
			labelsParam="${labelsParam},"
		fi
		labelsParam="${labelsParam}$(urlencode "${label}")"
	done
else
	labelsParam=
fi
if [ "${#assignees[@]}" != 0 ]; then
	assigneesParam='&assignee_ids='
	first=1
	for username in "${assignees[@]}"; do
		if [ "${first}" = 1 ]; then
			first=0
		else
			assigneesParam="${assigneesParam},"
		fi
		uid="$(fetchUid "${username}")"
		assigneesParam="${assigneesParam}${uid}"
	done
	
else
	assigneesParam=
fi
if [ "${#reviewers[@]}" != 0 ]; then
	reviewersParam='&reviewer_ids='
	first=1
	for username in "${reviewers[@]}"; do
		if [ "${first}" = 1 ]; then
			first=0
		else
			reviewersParam="${reviewersParam},"
		fi
		uid="$(fetchUid "${username}")"
		reviewersParam="${reviewersParam}${uid}"
	done
	
else
	reviewersParam=
fi

# Find existing MR
json="$(curl "${apiurl}/projects/$(urlencode "${slug}")/merge_requests?state=opened&source_branch=$(urlencode "${branch}")&target_branch=master")"
webUrl="$(jq -r '.[].web_url' <<< "${json}")"
if [ -n "${webUrl}" ]; then
	# Maybe update the MR
	if [ "${needsUpdate}" = 1 ]; then
		id="$(jq -r '.[].iid' <<< "${json}")"
		echo "Updating !${id}" >&2
		if [ -n "${title:-}" ]; then
			titleParam="&title=$(urlencode "${title}")"
		else
			titleParam=
		fi
		if [ -n "${body:-}" ]; then
			bodyParam="&title=$(urlencode "${body}")"
		else
			bodyParam=
		fi
		echo curl -XPUT "$(sed 's/&/?/' <<< "${apiurl}/projects/$(urlencode "${slug}")/merge_requests/${id}${titleParam}${bodyParam}${labelsParam}${assigneesParam}${reviewersParam}")" >/dev/null
	fi
	echo "$webUrl"
	exit 0
fi

# Create new MR
[ -z "${title:-}" ] && title="$(git log -1 --pretty=%s)"
[ -z "${body:-}" ] && body="$(git log -1 --pretty=%b)"
curl -XPOST "${apiurl}/projects/$(urlencode "${slug}")/merge_requests?source_branch=$(urlencode "${branch}")&target_branch=master&remove_source_branch=true&title=$(urlencode "${title}")&description=$(urlencode "${body}")${labelsParam}${assigneesParam}${reviewersParam}" | jq -r .web_url
